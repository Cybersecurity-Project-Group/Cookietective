# Automated Scanner for Cookie Leaking

The issue of potential third party access to private cookies has been a well known vulnerability and there have been particular security measures put in place on the web which track and limit third party access. For example, many services are in the business of selling user access information to third party servers for the sake of creating an advertising profile unique for each user through saving what websites and information users access. Since this is done through sharing first party cookies with third parties, this sharing is tracked and can be blocked by the aforementioned security procedures which were put in place to prevent malicious third party access. In order to avoid this, many websites now share third party cookies in manners which bypass these security measures.

## Requirements
The scanner utilizes Python libraries. To install the dependencies run the following code:

## Link Decorating
The most straightforward manner in which this is done is called link decoration, where parameters are added to URLs and HTTP packets that are passed to third party services, potentially sharing user data such as cookies or search queries. Although the types of cookies sent to third parties may vary, it could potentially contain sensitive information. Additionally if the third-party service is cloaked using CNAME, SameSite cookies can bypass cross-site limitations. There are no standards for checking the contents of HTTP packets for this and the cookie can be directly accessed by third parties listening in on network traffic, even Secure cookies. 

## CNAME Cloaking
The second method is called CNAME Cloaking, where third party servers are labeled as a subdomain of the first party server through the usage of a CNAME aliasing in the DNS server. CNAMEs unite resources used on a website under a single domain name by providing an alias that actually points to another domain. An identifying CNAME record is created to be part of a subdomain of a first party server, but instead of redirecting to an IP address in the domain, it redirects to a third party. So within the domain, a third party server is seen as if it is a first party subdomain. This can lead to leaking first-party cookies if it is paired with lax cookie settings where the Domain attribute automatically shares cookies with all domains of the ancestor-domain of the origin. Since cookies would be directly shared with all first-party subdomains, third party servers are able to receive whatever cookies the first party vendor specifies. This can create security vulnerabilities, as attackers can use these third party services to inject malicious code or steal user data.
Both of these methods are done with the direct intention of avoiding the built-in security features, and as such create incredibly vulnerable paths of attack since decorated links can be accessed relatively easily, and sharing through CNAME has no security measures tied to sharing with third parties, so the attacks which the built-in security measures attempt to prevent are no longer blocked in any way.

## Solution

Since both link decorations and CNAME cloaking bypass security and share cookies through direct paths, there is no easy way to detect an attack since the leakage can be exposed by the attacker without actively interacting with the first party network. As a result,  the best security approach against this type of attack is avoidance, as it allows a website operator to find potential issues before they are exploited by an attacker. Avoidance is particularly important in the case of cookie leakage, as it can be difficult to mitigate the damages after an attack has already occurred. Once an attacker has gained access to user data or injected malicious code into a website, users have already been affected, and since it is hard to detect when the attacker gained access, it is also difficult to set up a recovery system for the network. 

Finding CNAME cloaking vulnerabilities involves being able to track that CNAME aliasing is implemented for a third-party service and scanning cookie settings for lax Domain attributes. In our solution, we plan on utilizing a combination of techniques including website crawling, scanning network traffic, analyzing DNS records, and comparing CNAME aliases to known third party domains. Our implementation will be in the form of an automated scanner that crawls through a website accessing all of its content and resources then scanning network traffic to see what DNS resources are accessed. The goal of such a system would be scanning for instances of CNAME cloaking of third party tracking and advertising services that may cause security vulnerabilities. However, in practice, it is challenging to determine if packets scanned come from first or third party domains, and as such we are using a mix of different methods used by research papers studying the topic.

### Approach 1:
One approach to labeling CNAME aliased domains as first or third party is to compare the domains saved by the scanner with lists of domains known to be or not to be third party tracking and advertising services. This approach was used in the paper Oversharing is Not Caring: How CNAME Cloaking Can Expose Your Session Cookies by Assel Aliyeva and Manuel Egele for the purpose of training a machine learning algorithm. The method used in the paper was to train the features based on the No-tracking community’s blacklist of known T/A services and the Majestic Million’s list of most commonly searched websites but are not on the blacklist (since it can be assumed they were checked and found not to be a T/A service). For the purposes of our scanner, we are planning on using a similar method where we categorize a domain as third party if it can be found on the blacklist, but if it is not on the blacklist nor the Majestic Million list (not known to be first or third party) we will then go on to the second approach.

### Approach 2:
The second approach is based on scanning the domains listed in the Domain attribute of first party cookies and parsing through each possible domain to check for where cookies can be leaked. This method comes from the research paper Risk Analysis of Cookie Sharing by Link Decoration and CNAME Cloaking by Yuta Takata et. al. In it, they categorize first party cookie leaking if a domain in the Domain attribute has no A-type records, has CNAME records, has a non-first party name in the CNAME record, and if the domain IP address is not an IP address of the original URL. We will utilize this method to check if any of the domains labeled as third party get cookies shared with them as well as checking if each unknown domain meets the previously mentioned criteria. If either of the above are found to occur, then the scanner will mark the website as being vulnerable to first party cookie leakage.

Link decorating is much more straightforward to find. A scanner simply must check if cookie ids or other parameters in the URL are sent to a third party.


